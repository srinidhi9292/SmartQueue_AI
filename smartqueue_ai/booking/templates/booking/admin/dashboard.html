{% extends 'booking/base.html' %}
{% block title %}Analytics Dashboard{% endblock %}
{% block extra_css %}
<style>
.admin-layout { display:flex; min-height:calc(100vh - 67px); }
.main-content { flex:1; padding:36px; overflow-x:hidden; background:transparent; }
@media(max-width:768px) { .admin-sidebar{display:none!important} .main-content{padding:20px} }
/* ── FORCE ALL TEXT VISIBLE ── */
.main-content h1,.main-content h2,.main-content h3,.main-content h4,.main-content h5,.main-content h6 { color:#e8eeff !important; }
.main-content p { color:#6b7db3; }
.card h6 { color:#e8eeff !important; }
.table td { color:#e8eeff !important; font-size:.9rem; }
.table th { color:#8fa8cc !important; }
.table-light { background:rgba(15,22,41,0.7) !important; }
.table-light th { color:#8fa8cc !important; background:transparent !important; }
.stat-number { color:#e8eeff !important; }
.stat-label  { color:rgba(232,238,255,0.5) !important; }
</style>
{% endblock %}

{% block content %}
<div class="admin-layout" style="position:relative;z-index:1">
    <!-- Sidebar -->
    <div class="admin-sidebar">
        <div class="px-4 mb-4">
            <div style="font-size:.7rem;text-transform:uppercase;letter-spacing:2px;color:var(--muted)">Admin Panel</div>
        </div>
        <nav class="nav flex-column gap-1">
            <a class="nav-link active" href="{% url 'admin_dashboard' %}"><i class="bi bi-speedometer2"></i>Dashboard</a>
            <a class="nav-link" href="{% url 'admin_appointments' %}"><i class="bi bi-calendar-check"></i>Appointments</a>
            <a class="nav-link" href="{% url 'admin_services' %}"><i class="bi bi-grid-3x3-gap"></i>Services</a>
            <a class="nav-link" href="{% url 'admin_timeslots' %}"><i class="bi bi-clock"></i>Time Slots</a>
            <a class="nav-link" href="{% url 'admin_blocked_dates' %}"><i class="bi bi-calendar-x"></i>Blocked Dates</a>
            <a class="nav-link" href="{% url 'admin_analytics' %}"><i class="bi bi-graph-up"></i>Analytics</a>
            <div style="height:1px;background:var(--border);margin:12px 16px"></div>
            <a class="nav-link" href="{% url 'home' %}"><i class="bi bi-house"></i>Public Site</a>
        </nav>
    </div>

    <!-- Main -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <span class="section-label mb-2 d-inline-flex">Real-time</span>
                <h3 style="font-family:'Syne',sans-serif;font-weight:800;margin:0;letter-spacing:-0.5px">Analytics Dashboard</h3>
                <p style="color:var(--muted);margin:0;font-size:.88rem">SmartQueue AI · Live insights</p>
            </div>
            <a href="{% url 'admin_appointments' %}" class="btn btn-primary px-4" style="border-radius:50px">
                <i class="bi bi-list-check me-2"></i>Manage Appointments
            </a>
        </div>

        <!-- Stat Cards -->
        <div class="row g-3 mb-5">
            <div class="col-6 col-xl-2">
                <div class="stat-card bg-primary text-center">
                    <div class="stat-number" style="color:#fff!important">{{ total_bookings }}</div>
                    <div class="stat-label">Total</div>
                </div>
            </div>
            <div class="col-6 col-xl-2">
                <div class="stat-card bg-warning text-center">
                    <div class="stat-number" style="color:#fff!important">{{ pending_bookings }}</div>
                    <div class="stat-label">Pending</div>
                </div>
            </div>
            <div class="col-6 col-xl-2">
                <div class="stat-card bg-success text-center">
                    <div class="stat-number" style="color:#fff!important">{{ approved_bookings }}</div>
                    <div class="stat-label">Approved</div>
                </div>
            </div>
            <div class="col-6 col-xl-2">
                <div class="stat-card bg-info text-center">
                    <div class="stat-number" style="color:#fff!important">{{ completed_bookings }}</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>
            <div class="col-6 col-xl-2">
                <div class="stat-card bg-danger text-center">
                    <div class="stat-number" style="color:#fff!important">{{ cancelled_bookings }}</div>
                    <div class="stat-label">Cancelled</div>
                </div>
            </div>
            <div class="col-6 col-xl-2">
                <div class="stat-card text-center" style="background:linear-gradient(135deg,rgba(162,89,255,0.18),rgba(162,89,255,0.04));border-color:rgba(162,89,255,0.3)">
                    <div class="stat-number" style="color:var(--violet)!important">{{ checked_in_bookings }}</div>
                    <div class="stat-label">Checked In</div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card p-4 chart-card h-100">
                    <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--primary),var(--cyan));border-radius:20px 20px 0 0"></div>
                    <h6 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:20px"><i class="bi bi-bar-chart me-2" style="color:var(--primary)"></i>Daily Bookings — Last 30 Days</h6>
                    <canvas id="dailyChart" height="75"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card p-4 chart-card h-100">
                    <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--violet),var(--primary));border-radius:20px 20px 0 0"></div>
                    <h6 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:20px"><i class="bi bi-pie-chart me-2" style="color:var(--violet)"></i>Status Distribution</h6>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="card p-4 chart-card h-100">
                    <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--warning),var(--gold));border-radius:20px 20px 0 0"></div>
                    <h6 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:20px"><i class="bi bi-activity me-2" style="color:var(--warning)"></i>Peak Hour Analysis</h6>
                    <canvas id="peakChart" height="100"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card p-4 chart-card h-100">
                    <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--emerald),var(--cyan));border-radius:20px 20px 0 0"></div>
                    <h6 style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:20px"><i class="bi bi-trophy me-2" style="color:var(--emerald)"></i>Most Booked Services</h6>
                    <canvas id="serviceChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Appointments -->
        <div class="card p-4">
            <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--primary),var(--violet));border-radius:20px 20px 0 0"></div>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h6 style="font-family:'Syne',sans-serif;font-weight:700;margin:0"><i class="bi bi-clock-history me-2" style="color:var(--primary)"></i>Recent Appointments</h6>
                <a href="{% url 'admin_appointments' %}" class="btn btn-outline-primary btn-sm" style="border-radius:50px">View All</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr><th>#</th><th>User</th><th>Service</th><th>Date</th><th>Wait</th><th>Status</th><th>Action</th></tr>
                    </thead>
                    <tbody>
                        {% for appt in recent_appointments %}
                        <tr>
                            <td style="color:var(--muted);font-size:.85rem">{{ appt.pk }}</td>
                            <td>
                                <div style="font-weight:600;font-size:.9rem">{{ appt.user.get_full_name|default:appt.user.username }}</div>
                                <div style="color:var(--muted);font-size:.78rem">{{ appt.user.email }}</div>
                            </td>
                            <td style="font-size:.9rem">{{ appt.service.name }}</td>
                            <td style="font-size:.85rem;color:var(--muted)">{{ appt.timeslot.date|date:"d M" }} · {{ appt.timeslot.start_time|time:"g:i A" }}</td>
                            <td>
                                {% with wt=appt.estimated_waiting_time %}
                                {% if wt == 0 %}<span style="color:var(--emerald);font-weight:600;font-size:.85rem">No Wait</span>
                                {% else %}<span style="color:var(--warning);font-weight:600;font-size:.85rem">~{{ wt }}m</span>{% endif %}
                                {% endwith %}
                            </td>
                            <td><span class="badge badge-{{ appt.status }} rounded-pill px-3">{{ appt.get_status_display }}</span></td>
                            <td>
                                {% if appt.status == 'pending' %}
                                <form method="post" action="{% url 'admin_appointment_action' appt.pk 'approve' %}" class="d-inline">{% csrf_token %}<button class="btn btn-success btn-sm me-1">✓</button></form>
                                <form method="post" action="{% url 'admin_appointment_action' appt.pk 'reject' %}" class="d-inline">{% csrf_token %}<button class="btn btn-outline-danger btn-sm">✕</button></form>
                                {% elif appt.status == 'approved' or appt.status == 'checked_in' %}
                                <form method="post" action="{% url 'admin_appointment_action' appt.pk 'complete' %}" class="d-inline">{% csrf_token %}<button class="btn btn-info btn-sm">Done</button></form>
                                {% else %}<span style="color:var(--muted)">—</span>{% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="7" class="text-center py-5" style="color:var(--muted)">No appointments yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
Chart.defaults.font.family = "'DM Sans', sans-serif";
Chart.defaults.color = '#6b7db3';

const palette = ['#5b8fff','#00ffa3','#ffb347','#ff4d6d','#a259ff','#00e5ff','#ffcc00'];

const gridOpts = {
    color: 'rgba(99,130,255,0.06)',
    borderColor: 'transparent',
};

// Daily Bookings
new Chart(document.getElementById('dailyChart'), {
    type: 'bar',
    data: {
        labels: {{ daily_labels|safe }},
        datasets: [{
            label: 'Bookings',
            data: {{ daily_counts|safe }},
            backgroundColor: 'rgba(91,143,255,0.5)',
            borderColor: 'rgba(91,143,255,0.8)',
            borderWidth: 1,
            borderRadius: 6,
            hoverBackgroundColor: 'rgba(91,143,255,0.8)',
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 }, grid: gridOpts, border: { display: false } },
            x: { grid: { display: false }, border: { display: false } }
        }
    }
});

// Status Doughnut
new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
        labels: {{ status_labels|safe }},
        datasets: [{ data: {{ status_data|safe }}, backgroundColor: palette, borderWidth: 0, hoverOffset: 8 }]
    },
    options: {
        cutout: '68%',
        plugins: { legend: { position: 'bottom', labels: { padding: 16, usePointStyle: true } } }
    }
});

// Peak Hours
new Chart(document.getElementById('peakChart'), {
    type: 'line',
    data: {
        labels: {{ peak_labels|safe }},
        datasets: [{
            label: 'Bookings',
            data: {{ peak_data|safe }},
            borderColor: '#ffb347',
            backgroundColor: 'rgba(255,179,71,0.1)',
            fill: true, tension: 0.45,
            pointBackgroundColor: '#ffb347',
            pointRadius: 4,
        }]
    },
    options: {
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, grid: gridOpts, border: { display: false } },
            x: { grid: { display: false }, border: { display: false } }
        }
    }
});

// Services Bar
new Chart(document.getElementById('serviceChart'), {
    type: 'bar',
    data: {
        labels: {{ service_labels|safe }},
        datasets: [{
            label: 'Bookings',
            data: {{ service_counts|safe }},
            backgroundColor: palette,
            borderRadius: 8,
        }]
    },
    options: {
        indexAxis: 'y',
        plugins: { legend: { display: false } },
        scales: {
            x: { beginAtZero: true, grid: gridOpts, border: { display: false } },
            y: { grid: { display: false }, border: { display: false } }
        }
    }
});
</script>
{% endblock %}
